<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Deployment Strategies - Ultimate Kubernetes Bootcamp</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Deployment Strategies";
    var mkdocs_page_input_path = "9_deployement_strategies.md";
    var mkdocs_page_url = "/9_deployement_strategies/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ultimate Kubernetes Bootcamp</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../minikube/">Using minikube to setup single node environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../2_kube_cluster_vagrant/">Provisioning VMs with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../kube_visualizer/">Kuberentes Visualizer</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Bootcamp</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Launching Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">High Availability with Replica Sets</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Service Discovery and Publishing App</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Creating Deployments</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Using Configmaps and Secrets</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Persistent Volume Setup</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Being Edited</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Deployment Strategies</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#canary-releases">Canary  Releases</a></li>
    

    <li class="toctree-l3"><a href="#bluegreen-releases">Blue/Green  Releases</a></li>
    

    <li class="toctree-l3"><a href="#recreate">Recreate</a></li>
    

    <li class="toctree-l3"><a href="#pauseunpause">Pause/Unpause</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">Mini Project</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../cluster_setup_kubespray/">Production grade setup with Kubespray</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Securing Kubernetes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Authentication and Authorization</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ultimate Kubernetes Bootcamp</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Being Edited &raquo;</li>
        
      
    
    <li>Deployment Strategies</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h3 id="canary-releases">Canary  Releases</h3>
<pre><code>cd step4
cd projets/mogambo/dev
mkdir canary
</code></pre>

<p>File: canary/frontend-canary-deploy.yml</p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: frontend-canary
  namespace: mogambo
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  minReadySeconds: 40
  revisionHistoryLimit: 4
  paused: false
  template:
    metadata:
      name: frontend
      labels:
        tier: &quot;1&quot;
        app: frontend
        env: dev
        release: canary
    spec:
      containers:
        - name: frontend
          image: schoolofdevops/frontend:v2.0
          ports:
            - containerPort: 8079
              protocol: TCP

</code></pre>

<p>deploy the canary version</p>
<pre><code>
kubectl apply -f canary/frontend-canary-deploy.yml

</code></pre>

<h3 id="bluegreen-releases">Blue/Green  Releases</h3>
<pre><code>cd step4
cd projets/mogambo/dev
mkdir blue-green

</code></pre>

<p>file: frontend-blue-deploy.yml</p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: frontend-blue
  namespace: mogambo
spec:
  replicas: 5
  strategy:
    type: Recreate
  minReadySeconds: 40
  revisionHistoryLimit: 4
  paused: false
  template:
    metadata:
      name: frontend
      labels:
        tier: &quot;1&quot;
        app: frontend
        env: dev
        release: bluegreen
        code: blue
    spec:
      containers:
        - name: frontend
          image: schoolofdevops/frontend:v3.0
          ports:
            - containerPort: 8079
              protocol: TCP

</code></pre>

<p>file: step5/projects/mogambo/dev/blue-green/frontend-green-deploy.yml</p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: frontend-green
  namespace: mogambo
spec:
  replicas: 5
  strategy:
    type: Recreate
  minReadySeconds: 40
  revisionHistoryLimit: 4
  paused: false
  template:
    metadata:
      name: frontend
      labels:
        tier: &quot;1&quot;
        app: frontend
        env: dev
        release: bluegreen
        code: green
    spec:
      containers:
        - name: frontend
          image: schoolofdevops/frontend:v1.0
          ports:
            - containerPort: 8079
              protocol: TCP

</code></pre>

<p>file: blue-green/frontend-test-svc.yml</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: frontend-test
  namespace: mogambo
spec:
  selector:
    app: frontend
    env: dev
    release: bluegreen
    code: blue
  ports:
    - port: 8079
      protocol: TCP
      targetPort: 8079
  type: NodePort

</code></pre>

<p>file: frontend-svc.yml</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: mogambo
spec:
  selector:
    app: frontend
    env: dev
    release: bluegreen
    code: blue
  ports:
    - port: 8079
      protocol: TCP
      targetPort: 8079
  type: NodePort

</code></pre>

<h3 id="recreate">Recreate</h3>
<p>When the <strong>Recreate</strong> deployment strategy is used,
  * The old pods will be deleted
  * Then the new pods will be created.</p>
<p>This will create some downtime in our stack. Hence, this strategy is only recommended for development use cases.</p>
<p>Let us change the deployment strategy to <strong>recreate</strong> and image tag to <em>latest</em>.</p>
<p>file: catalogue-deploy.yml</p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: catalogue
  namespace: mogambo
  labels:
    app: catalogue
    env: dev
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: catalogue
        env: dev
    spec:
      tolerations:
        - key: &quot;dedicate&quot;
          operator: &quot;Equal&quot;
          value: &quot;catalogue&quot;
          effect: &quot;NoExecute&quot;
      containers:
        - name: catalogue
          image: schoolofdevops/catalogue:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 80

</code></pre>

<h3 id="pauseunpause">Pause/Unpause</h3>
<p>When you are in the middle of a new update for your application and you found out that the application is behaving as intended. In those situations,
  1. we can pause the update,
  2. fix the issue,
  3. resume the update.</p>
<p>Let us change the image tag to V2 in pod spec.</p>
<p><code>File: catalogue-deploy.yml</code></p>
<pre><code>      containers:
        - name: catalogue
          image: schoolofdevops/catalogue:V2
          imagePullPolicy: Always
          ports:
            - containerPort: 80
</code></pre>

<p>Apply the changes.</p>
<pre><code>kubectl apply -f catalogue-deploy.yml

kubectl get pods

[Output]
NAME                         READY     STATUS         RESTARTS   AGE
catalogue-6c4f7b49d8-g5dgc   1/1       Running        0          16m
catalogue-765554cc7-xsbhs    0/1       ErrImagePull   0          9s
</code></pre>

<p>Our deployment is failing. From some debugging, we can conclude that we are using a wrong image tag.</p>
<p>Now pause the update</p>
<pre><code>kubectl rollout pause
</code></pre>

<p>Set the deployment to use <strong>v2</strong> version of the image.</p>
<pre><code>kubectl set image deployment catalogue catalogue=schoolofdevops/catalogue:v2

[output]
deployment &quot;catalogue&quot; image updated
</code></pre>

<p>Now resume the update</p>
<pre><code>kubectl rollout resume deployment catalogue
kubectl rollout status deployment catalogue

[Ouput]
deployment &quot;catalogue&quot; successfully rolled out
</code></pre>

<pre><code>kubectl get pods

[Output]
NAME                         READY     STATUS    RESTARTS   AGE
catalogue-6875c8df8f-k4hls   1/1       Running   0          1m
</code></pre>

<p>When we do this, we skip the need of creating a new rolling update altogether.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../10_kubernetes_autoscaling/" class="btn btn-neutral float-right" title="Auto Scaling Capacity with HPA">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../vote-persistent-volumes/" class="btn btn-neutral" title="Persistent Volume Setup"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../vote-persistent-volumes/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../10_kubernetes_autoscaling/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
