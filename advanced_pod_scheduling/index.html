<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Advanced Pod Scheduling - Ultimate Kubernetes Bootcamp</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Advanced Pod Scheduling";
    var mkdocs_page_input_path = "advanced_pod_scheduling.md";
    var mkdocs_page_url = "/advanced_pod_scheduling/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Ultimate Kubernetes Bootcamp</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../minikube/">Using minikube to setup single node environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../2_kube_cluster_vagrant/">Provisioning VMs with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../kube_visualizer/">Kuberentes Visualizer</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Fundamentals</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Launching Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Making application highly available</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Publishing appliaction and Service Discovery</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Defining Update Strategy</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Managing Configurations and Secrets</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Making Data Persist</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">Mini Project</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Advanced Kubernetes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../kubespray-prereqs/">Kubespray lab setup with Vagrant</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster_setup_kubespray/">Production grade setup with Kubespray</a>
                </li>
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Authentication and Authorization (RBAC)</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Advanced Pod Scheduling</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#advanced-pod-scheduling">Advanced Pod Scheduling</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#using-node-selectors">Using Node Selectors</a></li>
        
            <li><a class="toctree-l4" href="#resource-requests-and-limits">Resource requests and limits</a></li>
        
            <li><a class="toctree-l4" href="#defining-nodepod-affinity-and-anti-affinity">Defining node/pod affinity and anti-affinity</a></li>
        
            <li><a class="toctree-l4" href="#taints-and-tolerations">Taints and tolerations</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">Building Deployment Strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Creating Replicated Cluster Setup for Redis</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Ingress Controllers</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Ultimate Kubernetes Bootcamp</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Advanced Kubernetes &raquo;</li>
        
      
    
    <li>Advanced Pod Scheduling</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="advanced-pod-scheduling">Advanced Pod Scheduling</h1>
<p>In the Kubernetes bootcamp training, we have seen how to create a pod and and some basic pod configurations to go with it. But this chapter explains some advanced topics related to pod scheduling.</p>
<p>From the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#pod-v1-core">api document for version 1.11</a> following are the pod specs which are relevant from scheduling perspective.</p>
<ul>
<li>affinity</li>
<li>nodeName</li>
<li>nodeSelector</li>
<li>schedulerName</li>
<li>tolerations</li>
</ul>
<h2 id="using-node-selectors">Using Node Selectors</h2>
<pre><code>kubectl get nodes --show-labels

kubectl label nodes &lt;node-name&gt; zone=aaa

kubectl get nodes --show-labels

</code></pre>

<p>e.g.</p>
<pre><code>kubectl label nodes node1 zone=bbb
kubectl label nodes node2 zone=bbb
kubectl label nodes node3 zone=aaa
kubectl label nodes node4 zone=aaa
kubectl get nodes --show-labels
</code></pre>

<p>[sample output]</p>
<pre><code>NAME      STATUS    ROLES         AGE       VERSION   LABELS
node1     Ready     master,node   22h       v1.10.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node1,node-role.kubernetes.io/master=true,node-role.kubernetes.io/node=true,zone=bbb
node2     Ready     master,node   22h       v1.10.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node2,node-role.kubernetes.io/master=true,node-role.kubernetes.io/node=true,zone=bbb
node3     Ready     node          22h       v1.10.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node3,node-role.kubernetes.io/node=true,zone=aaa
node4     Ready     node          21h       v1.10.4   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node4,node-role.kubernetes.io/node=true,zone=aaa
</code></pre>

<p>Now, update pod definition to make it schedule only on nodes in zone <strong>bbb</strong></p>
<p><code>file: k8s-code/pods/frontend-pod.yml</code></p>
<pre><code>apiVersion: v1
kind: Pod
metadata:
  name: front-end
  labels:
    app: front-end
    role: ui
    tier: front
spec:
  containers:
    - name: front-end
      image: schoolofdevops/frontend:latest
      ports:
        - containerPort: 8079
   nodeSelector:
    zone: 'bbb'
</code></pre>

<p>For this change, pod needs to be re created.</p>
<pre><code>kubectl apply -f frontend-pod.yml
</code></pre>

<h2 id="resource-requests-and-limits">Resource requests and limits</h2>
<p>We can control the amount of resource requested and used by all the pods. This can be done by adding following data the deployment template.</p>
<h3 id="resource-request">Resource Request</h3>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 3
          resources:
            requests:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
</code></pre>

<p>This ensures that pod always get the minimum cpu and memory specified. But this does not restrict the pod from accessing additional resources if needed. Thats why we have to use <strong>resource limit</strong> to limit the resource usage by a pod.</p>
<p><code>Expected output:</code></p>
<pre><code>kubectl describe pod front-end-5c64b7c5cc-cwgr5

[...]
Containers:
  front-end:
    Container ID:
    Image:          schoolofdevops/frontend
    Image ID:
    Port:           8079/TCP
    State:          Waiting
      Reason:       ContainerCreating
    Ready:          False
    Restart Count:  0
    Requests:
      cpu:        250m
      memory:     128Mi
</code></pre>

<h3 id="resource-limit">Resource limit</h3>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 3
          resources:
            requests:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
            limits:
              memory: &quot;256Mi&quot;
              cpu: &quot;500m&quot;
</code></pre>

<p><code>Expected output:</code></p>
<pre><code>kubectl describe pod front-end-5b877b4dff-5twdd

[...]
Containers:
  front-end:
    Container ID:   docker://d49a08c18fd9651af2f3dd28772da977b238a4010f14372e72e0ca24dcec8554
    Image:          schoolofdevops/frontend
    Image ID:       docker-pullable://schoolofdevops/frontend@sha256:94b7a0843f99223a8a1d284fdeeb3fd5a731c03aea57a52751c6ebde40be1f50
    Port:           8079/TCP
    State:          Running
      Started:      Thu, 08 Feb 2018 17:14:54 +0530
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  256Mi
    Requests:
      cpu:        250m
      memory:     128Mi
</code></pre>

<h2 id="defining-nodepod-affinity-and-anti-affinity">Defining node/pod affinity and anti-affinity</h2>
<p>We have discussed about scheduling a pod on a particular node using <strong>NodeSelector</strong>, but using node selector is a hard condition. If the condition is not met, the pod cannot be scheduled. Node/Pod affinity and anti-affinity solves this issue by introducing soft and hard conditions.</p>
<h3 id="node-affinity">Node Affinity</h3>
<p>Let us label our node1 to <strong>fruit=apple</strong>.</p>
<pre><code>kubectl label node node1 fruit=apple

</code></pre>

<p>Let us modify our deployment file to take advantage of this newly labeled node.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            preference:
              matchExpressions:
              - key: fruit
                operator: In
                values:
                - apple
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 3
          resources:
            requests:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
            limits:
              memory: &quot;256Mi&quot;
              cpu: &quot;500m&quot;
</code></pre>

<p>This is a soft affinity. If there are no nodes labeled as apple, the pod would have still be scheduled.</p>
<p><strong>Task:</strong> Change the label value to some other fruit name and check the scheduling.</p>
<p>Let us test the <strong>hard node affinity</strong>. This condition must be met for the pod to be scheduled. Change the deployment file as given below.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: fruit
                operator: In
                values:
                - orange
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 3
          resources:
            requests:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
            limits:
              memory: &quot;256Mi&quot;
              cpu: &quot;500m&quot;
</code></pre>

<p><code>Expected output:</code></p>
<pre><code>kubectl describe pod front-end-d7b787cdf-hhvfr

[...]
Events:
  Type     Reason            Age               From               Message
  ----     ------            ----              ----               -------
  Warning  FailedScheduling  32s (x8 over 1m)  default-scheduler  0/4 nodes are available: 4 MatchNodeSelector.
</code></pre>

<h3 id="node-anti-affinity">Node Anti-Affinity</h3>
<p>Node anti-affinity can be achieved by using <strong>NotIn</strong> operator. This will help us to ignore nodes while scheduling.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: front-end
  namespace: instavote
  labels:
    app: front-end
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: front-end
        env: dev
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: fruit
                operator: NotIn
                values:
                - orange
      containers:
        - name: front-end
          image: schoolofdevops/frontend
          imagePullPolicy: Always
          ports:
            - containerPort: 8079
          livenessProbe:
            tcpSocket:
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8079
            initialDelaySeconds: 5
            periodSeconds: 3
          resources:
            requests:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
            limits:
              memory: &quot;256Mi&quot;
              cpu: &quot;500m&quot;
</code></pre>

<p>This will schedule the pod on nodes other than node1.</p>
<h3 id="pod-affinity">Pod Affinity</h3>
<p>Node affinity allows you to schedule pods on selective nodes. But what if you want to run pods along with other pods selectively. Pod affinity helps us with that.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>[..]
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - catalogue
              topologyKey: kubernetes.io/hostname
</code></pre>

<p><code>Expected output:</code></p>
<pre><code>kubectl describe pod front-end-85cc68d56b-4djtt

[...]
Events:
  Type     Reason            Age               From               Message
  ----     ------            ----              ----               -------
  Warning  FailedScheduling  7s (x5 over 14s)  default-scheduler  0/4 nodes are available: 4 MatchInterPodAffinity, 4 PodAffinityRulesNotMatch
</code></pre>

<p>This is a hard pod affinity. If none of the node has a pod running with label <strong>app=catalogue</strong>, the pod will not be scheduled at all. Here <strong>topologyKey</strong> is a label of a node. This can be any node label.</p>
<h3 id="pod-anti-affinity">Pod Anti-Affinity</h3>
<p>Pod anti-affinity works the opposite way of pod affinity.</p>
<p>Lets create <strong>catalogue</strong> deployment this time.</p>
<pre><code>kubectl apply -f catalogue-deploy.yml
</code></pre>

<p>Catalogue deployment has a label called <strong>app=catalogue</strong>. Check on which node catalogue pod is running.</p>
<pre><code>kubectl get pods -o wide

NAME                         READY     STATUS    RESTARTS   AGE       IP             NODE
catalogue-86647dcb5b-f6t2j   1/1       Running   0          9s        10.233.71.52   node3
</code></pre>

<p>Change the front-end deployment file as follows.</p>
<p><code>File: code/frontend-deploy.yml</code></p>
<pre><code>[...]
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - catalogue
              topologyKey: kubernetes.io/hostname
</code></pre>

<p>Now apply the deployment.</p>
<pre><code>kubectl apply -f frontend-deploy.yml
kubectl get pods -o wide

NAME                         READY     STATUS    RESTARTS   AGE       IP               NODE
catalogue-86647dcb5b-f6t2j   1/1       Running   0          2m        10.233.71.52     node3
front-end-5cbc986f44-mjr5m   1/1       Running   0          1m        10.233.102.134   node1
</code></pre>

<h2 id="taints-and-tolerations">Taints and tolerations</h2>
<p>Taint the node.</p>
<pre><code>kubectl taint node node4 dedicate=catalogue:NoExecute
</code></pre>

<p>Apply toleration in the Deployment.</p>
<p><code>File: code/catalogue-deploy.yml</code></p>
<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: catalogue
  namespace: instavote
  labels:
    app: catalogue
    env: dev
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: catalogue
        env: dev
    spec:
      tolerations:
        - key: &quot;dedicate&quot;
          operator: &quot;Equal&quot;
          value: &quot;catalogue&quot;
          effect: &quot;NoExecute&quot;
      containers:
        - name: catalogue
          image: schoolofdevops/catalogue
          imagePullPolicy: Always
          ports:
            - containerPort: 80
</code></pre>

<p>Check the pod list. This catalogue pod will only be scheduled in node4. If there were any pod running in node4, before it got tainted, will be evicted to other hosts.</p>
<hr />
<p>Need to talk about what a hard and soft affinity is. May need the change the node label used.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pods-health-probes/" class="btn btn-neutral float-right" title="Adding health checks with Probes">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../configuring_authentication_and_authorization/" class="btn btn-neutral" title="Authentication and Authorization (RBAC)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../configuring_authentication_and_authorization/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../pods-health-probes/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
